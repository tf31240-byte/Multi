<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#F5F5F7" media="(prefers-color-scheme: light)">
    <title>ScoreMaster v11.0 Multiplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Firebase pour sync multi-appareils -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #007AFF; --bg: #F5F5F7; --card: #FFFFFF; --text: #1D1D1F;
            --text-sec: #86868B; --border: #E5E5EA; --dealer: #FF9500; 
            --danger: #FF3B30; --success: #34C759; --shadow: 0 8px 30px rgba(0,0,0,0.08);
            --gold: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            --silver: linear-gradient(135deg, #C0C0C0 0%, #8E8E93 100%);
            --bronze: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);
        }
        :root[data-theme="dark"] {
            --primary: #0A84FF; --bg: #000000; --card: #1C1C1E; --text: #F5F5F7;
            --text-sec: #98989D; --border: #38383A; --shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --primary: #0A84FF; --bg: #000000; --card: #1C1C1E; --text: #F5F5F7;
                --text-sec: #98989D; --border: #38383A; --shadow: 0 8px 30px rgba(0,0,0,0.4);
            }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 140px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-top: env(safe-area-inset-top); animation: slideIn 0.4s ease-out; }
        .hidden { display: none !important; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .game-actions { display: flex; gap: 8px; }
        .game-actions button { background: none; border: none; font-size: 18px; padding: 8px; cursor: pointer; transition: transform 0.2s; }
        .game-actions button:active { transform: scale(0.9); }
        
        .welcome-title { font-size: 42px; font-weight: 900; text-align: center; margin-top: 40px; letter-spacing: -2px; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .theme-toggle { background: var(--card); border: 1px solid var(--border); width: 44px; height: 44px; border-radius: 12px; font-size: 20px; cursor: pointer; transition: all 0.3s; }
        .theme-toggle:active { transform: scale(0.9); }
        .mode-btn { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 12px; box-shadow: var(--shadow); cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s; }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.12); }
        .mode-btn:active { transform: translateY(0); }
        .guide-container { margin-top: 30px; background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid var(--border); font-size: 13px; color: var(--text-sec); }
        
        .game-item { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 16px; margin-bottom: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .game-item:hover { border-color: var(--primary); transform: translateX(4px); }
        .game-mode-badge { display: inline-block; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 900; margin-left: 8px; }
        .badge-belote { background: #FF9500; color: white; }
        .badge-standard { background: #007AFF; color: white; }
        .game-players-list { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .game-player-score { font-size: 11px; padding: 4px 8px; border-radius: 8px; font-weight: 700; }
        
        .sync-indicator { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 900; z-index: 1000; display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow); animation: pulse 2s infinite; }
        .sync-indicator.disconnected { background: var(--danger); animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .chart-box { background: var(--card); border-radius: 24px; padding: 15px; height: 200px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .players-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; margin-bottom: 30px; }
        .p-card { background: var(--card); padding: 22px 10px; border-radius: 26px; text-align: center; position: relative; border: 3px solid transparent; box-shadow: var(--shadow); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), border-color 0.3s; }
        .p-card.is-dealer { border-color: var(--dealer); }
        .p-card.rank-change { animation: rankPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes rankPop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .rank-badge { position: absolute; top: -12px; left: 12px; font-size: 13px; padding: 4px 10px; border-radius: 12px; font-weight: 900; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .rank-badge.bounce { animation: badgeBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes badgeBounce { 0%, 100% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.3) rotate(-10deg); } 75% { transform: scale(1.3) rotate(10deg); } }
        .badge-1 { background: var(--gold); }
        .badge-2 { background: var(--silver); }
        .badge-3 { background: var(--bronze); }
        .badge-none { background: var(--text-sec); opacity: 0.5; }
        
        .p-name-btn { font-size: 12px; font-weight: 900; text-transform: uppercase; cursor: pointer; display: inline-block; padding: 4px 10px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; }
        .p-score { font-size: 44px; font-weight: 900; cursor: pointer; line-height: 1; letter-spacing: -2px; transition: transform 0.2s ease-out; }
        .p-score.score-bump { animation: scoreBump 0.4s ease-out; }
        @keyframes scoreBump { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .p-temp { font-size: 15px; font-weight: 800; color: var(--primary); min-height: 18px; margin-top: 6px; }
        
        .h-row { background: var(--card); padding: 12px; border-radius: 18px; display: flex; align-items: center; margin-bottom: 8px; border: 1px solid var(--border); gap: 10px; }
        .h-idx { font-size: 10px; font-weight: 900; color: var(--text-sec); min-width: 30px; flex-shrink: 0; }
        .h-scores { display: flex; flex: 1; justify-content: space-around; align-items: center; overflow: hidden; cursor: pointer; }
        .h-score-item { text-align: center; min-width: 40px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 4000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-box { background: var(--card); width: 100%; max-width: 340px; border-radius: 28px; padding: 25px; }
        
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
        .sheet-overlay.active { opacity: 1; pointer-events: auto; }
        .sheet-content { background: var(--bg); width: 100%; border-radius: 35px 35px 0 0; padding: 25px 20px calc(25px + env(safe-area-inset-bottom)); transform: translateY(100%); transition: 0.3s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .sheet-overlay.active .sheet-content { transform: translateY(0); }
        
        .sel-box { background: var(--card); padding: 12px; border-radius: 18px; text-align: center; flex: 1; border: 3px solid transparent; min-width: 80px; }
        .sel-box.active { border-color: var(--p-color); transform: scale(1.05); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn-nb { background: var(--card); border: none; height: 58px; border-radius: 16px; font-size: 22px; font-weight: 700; color: var(--text); box-shadow: 0 3px 0 var(--border); cursor: pointer; }
        
        .dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; z-index: 2000; }
        .btn-main { width: 100%; background: var(--text); color: var(--bg); border: none; padding: 20px; border-radius: 22px; font-size: 16px; font-weight: 900; box-shadow: 0 10px 30px rgba(0,0,0,0.2); cursor: pointer; }
        .btn-main.editing { background: var(--dealer); color: #000; }
        
        .toast { position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--card); padding: 16px 24px; border-radius: 20px; box-shadow: var(--shadow); font-weight: 700; z-index: 5000; opacity: 0; transition: all 0.3s; border: 1px solid var(--border); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: var(--success); background: var(--success); color: white; }
        .toast.warning { border-color: var(--dealer); background: var(--dealer); color: white; }
        .toast.error { border-color: var(--danger); background: var(--danger); color: white; }
        
        .victory-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 6000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .victory-overlay.active { opacity: 1; pointer-events: auto; }
        .victory-box { background: var(--card); border-radius: 32px; padding: 40px; text-align: center; max-width: 400px; animation: victoryPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .victory-title { font-size: 48px; margin-bottom: 20px; }
        .victory-player { font-size: 32px; font-weight: 900; margin-bottom: 30px; }
        .victory-stats { background: var(--bg); border-radius: 20px; padding: 20px; margin-bottom: 30px; text-align: left; }
        .victory-stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .victory-stat-row:last-child { border-bottom: none; }
        .victory-stat-label { color: var(--text-sec); font-size: 14px; font-weight: 600; }
        .victory-stat-value { color: var(--text); font-size: 16px; font-weight: 900; }
        @keyframes victoryPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .qr-container { text-align: center; padding: 30px; }
        .game-code { font-size: 48px; font-weight: 900; letter-spacing: 8px; color: var(--primary); margin: 20px 0; font-family: 'Courier New', monospace; }
        .join-input { width: 100%; padding: 20px; border-radius: 16px; border: 3px solid var(--border); font-size: 32px; font-weight: 900; text-align: center; letter-spacing: 8px; font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); margin-bottom: 20px; text-transform: uppercase; outline: none; }
        .join-input:focus { border-color: var(--primary); }
        .multiplayer-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 900; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <div id="setup" class="container">
        <div class="header-controls">
            <h1 class="welcome-title" style="margin:0; flex:1;">ScoreMaster</h1>
            <button id="theme-toggle" class="theme-toggle" onclick="app.toggleTheme()">üåô</button>
        </div>

        <div style="background: linear-gradient(135deg, var(--primary)15 0%, var(--card) 100%); border: 2px solid var(--primary); border-radius: 24px; padding: 20px; margin-bottom: 20px;">
            <h2 style="margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                <span>üåê</span> Mode Multijoueur
                <span id="firebase-status" style="font-size: 11px; padding: 3px 8px; border-radius: 8px; background: var(--text-sec); color: white; margin-left: auto;">CONFIG REQUISE</span>
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-main" style="padding: 16px; font-size: 14px; background: var(--primary); color: white;" onclick="Multiplayer.hostGame()">üì° H√âBERGER</button>
                <button class="btn-main" style="padding: 16px; font-size: 14px; background: var(--success); color: white;" onclick="Multiplayer.showJoinModal()">üîó REJOINDRE</button>
            </div>
            <p style="margin: 12px 0 0 0; font-size: 11px; color: var(--text-sec); text-align: center;">Jouez en temps r√©el avec d'autres appareils</p>
        </div>

        <div class="mode-btn" onclick="app.showModeSelection('belote')">
            <span style="font-size:30px; margin-right:15px;">üÉè</span>
            <div><h2 style="margin:0">Belote / Coinche</h2><p style="margin:4px 0 0; font-size:12px; color:var(--text-sec)">Points √† 162 ‚Ä¢ Capot 252</p></div>
        </div>
        <div class="mode-btn" onclick="app.showModeSelection('standard')">
            <span style="font-size:30px; margin-right:15px;">üé≤</span>
            <div><h2 style="margin:0">Standard</h2><p style="margin:4px 0 0; font-size:12px; color:var(--text-sec)">Scores libres ‚Ä¢ Multi-joueurs</p></div>
        </div>

        <div style="margin-top: 40px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-size:18px; font-weight:900;">üìö Historique des parties</h3>
                <button onclick="Storage.clearAll()" style="background:none; border:none; color:var(--danger); font-weight:900; font-size:12px; cursor:pointer;">TOUT EFFACER</button>
            </div>
            <div id="games-list"></div>
        </div>

        <div class="guide-container">
            <b style="display:block; margin-bottom:8px; color:var(--text)">üìñ Guide Rapide</b>
            ‚Ä¢ Cliquez sur le <b style="color:var(--text)">NOM</b> pour le donneur üÉè<br>
            ‚Ä¢ Cliquez sur le <b style="color:var(--text)">SCORE</b> pour les points ‚úçÔ∏è<br>
            ‚Ä¢ Cliquez sur l'<b style="color:var(--text)">HISTORIQUE</b> pour corriger ‚úèÔ∏è
        </div>
    </div>

    <div id="game" class="container hidden">
        <div id="sync-indicator" class="sync-indicator hidden">
            <span id="sync-icon">‚ö°</span>
            <span id="sync-text">Synchronis√©</span>
        </div>

        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h1 id="mode-title" style="margin:0; font-size:28px; font-weight:900;">SCORE</h1>
                <div id="multiplayer-info" class="hidden" style="margin-top: 4px;"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="app.showSetup()" style="background:var(--card); border:1px solid var(--border); width:40px; height:40px; border-radius:12px; cursor:pointer;">‚¨ÖÔ∏è</button>
            </div>
        </header>
        <div class="chart-box"><canvas id="chart"></canvas></div>
        <div id="grid" class="players-grid"></div>
        <div style="display:flex; justify-content:space-between; margin: 30px 0 10px; font-size:11px; font-weight:900; color:var(--text-sec);">
            <span>HISTORIQUE DES MANCHES</span>
            <div style="display:flex; gap:12px;">
                <button onclick="app.finishGame()" style="background:none; border:none; color:var(--success); font-weight:900; cursor:pointer;">‚úì TERMINER</button>
                <button onclick="app.undo()" style="background:none; border:none; color:var(--danger); font-weight:900; cursor:pointer;">ANNULER</button>
            </div>
        </div>
        <div id="history"></div>
    </div>

    <div id="dock" class="dock hidden">
        <button id="save-btn" class="btn-main" onclick="app.validateRound()">ENREGISTRER LA MANCHE</button>
    </div>

    <div id="modal-player" class="modal-overlay" onclick="if(event.target===this) app.closeModal()">
        <div class="modal-box">
            <h2 id="modal-title" style="margin:0 0 20px 0">Joueur</h2>
            <input type="text" id="edit-name" style="width:100%; padding:15px; border-radius:12px; border:2px solid var(--border); font-size:18px; font-weight:700; margin-bottom:20px; outline:none; background:var(--bg); color:var(--text);">
            <label style="display:flex; align-items:center; justify-content:space-between; background:var(--bg); padding:15px; border-radius:12px; font-weight:700; cursor:pointer;">
                Donneur üÉè <input type="checkbox" id="edit-dealer" style="width:20px; height:20px; accent-color:var(--dealer);">
            </label>
            <button class="btn-main" style="margin-top:20px; background:var(--primary); color:white" onclick="app.savePlayer()">VALIDER</button>
        </div>
    </div>

    <div id="modal-qr" class="modal-overlay" onclick="if(event.target===this) Multiplayer.closeQRModal()">
        <div class="modal-box">
            <h2 style="margin:0 0 10px 0; text-align: center;">üåê Partie Multijoueur</h2>
            <p style="text-align: center; color: var(--text-sec); font-size: 13px; margin-bottom: 20px;">Scannez ce QR code ou partagez le code</p>
            <div class="qr-container">
                <div id="qr-code" style="display: inline-block; padding: 20px; background: white; border-radius: 16px;"></div>
                <div class="game-code" id="game-code-display"></div>
                <button class="btn-main" style="background: var(--primary); color: white; margin-top: 10px;" onclick="Multiplayer.copyCode()">üìã COPIER LE CODE</button>
            </div>
            <button class="btn-main" style="margin-top: 20px; background: var(--success); color: white;" onclick="Multiplayer.startMultiplayerGame()">‚ñ∂Ô∏è COMMENCER LA PARTIE</button>
        </div>
    </div>

    <div id="modal-join" class="modal-overlay" onclick="if(event.target===this) Multiplayer.closeJoinModal()">
        <div class="modal-box">
            <h2 style="margin:0 0 10px 0; text-align: center;">üîó Rejoindre une partie</h2>
            <p style="text-align: center; color: var(--text-sec); font-size: 13px; margin-bottom: 20px;">Entrez le code de la partie</p>
            <input type="text" id="join-code-input" class="join-input" placeholder="ABC123" maxlength="6">
            <button class="btn-main" style="background: var(--primary); color: white;" onclick="Multiplayer.joinGame()">‚úì REJOINDRE</button>
            <button class="btn-main" style="margin-top: 10px; background: var(--card); border: 1px solid var(--border); color: var(--text);" onclick="Multiplayer.closeJoinModal()">ANNULER</button>
        </div>
    </div>

    <div id="sheet" class="sheet-overlay" onclick="app.closeSheet()">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div id="input-switcher" style="display:flex; gap:8px; margin-bottom:20px; overflow-x:auto;"></div>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:12px;">
                <button id="calc-btn" class="btn-nb hidden" style="grid-column:span 4; background:var(--success); color:white; font-size:14px; box-shadow:none;" onclick="app.calcRest()">‚ú® RESTE √Ä 162</button>
                <button class="btn-nb" style="background:rgba(120,120,128,0.12); font-size:14px; box-shadow:none;" onclick="app.addVal(10)">+10</button>
                <button class="btn-nb" style="background:rgba(120,120,128,0.12); font-size:14px; box-shadow:none;" onclick="app.addVal(20)">+20</button>
                <button id="btn-82" class="btn-nb hidden" style="background:rgba(120,120,128,0.12); font-size:14px; box-shadow:none;" onclick="app.addVal(82)">+82</button>
                <button id="btn-50" class="btn-nb hidden" style="background:rgba(120,120,128,0.12); font-size:14px; box-shadow:none;" onclick="app.addVal(50)">+50</button>
                <button id="smart-btn" class="btn-nb" style="background:var(--text); color:var(--bg); font-size:14px; box-shadow:none;" onclick="app.handleSmart()">+/-</button>
            </div>
            <div class="numpad">
                <button class="btn-nb" onclick="app.typeNum(1)">1</button><button class="btn-nb" onclick="app.typeNum(2)">2</button><button class="btn-nb" onclick="app.typeNum(3)">3</button>
                <button class="btn-nb" onclick="app.typeNum(4)">4</button><button class="btn-nb" onclick="app.typeNum(5)">5</button><button class="btn-nb" onclick="app.typeNum(6)">6</button>
                <button class="btn-nb" onclick="app.typeNum(7)">7</button><button class="btn-nb" onclick="app.typeNum(8)">8</button><button class="btn-nb" onclick="app.typeNum(9)">9</button>
                <button class="btn-nb" style="color:var(--danger)" onclick="app.clearInput()">C</button>
                <button class="btn-nb" onclick="app.typeNum(0)">0</button>
                <button class="btn-nb" onclick="app.backspace()">‚å´</button>
            </div>
            <button class="btn-main" style="margin-top:15px; background:var(--primary); color:white" onclick="app.closeSheet()">OK</button>
        </div>
    </div>

    <div id="victory" class="victory-overlay">
        <div class="victory-box">
            <div class="victory-title">üèÜ</div>
            <div id="victory-player" class="victory-player"></div>
            <div id="victory-score" style="font-size:18px; color:var(--text-sec); margin-bottom:20px;"></div>
            <div id="victory-stats" class="victory-stats"></div>
            <button class="btn-main" style="background:var(--primary); color:white; margin-bottom:12px;" onclick="app.restartWithSamePlayers()">üîÑ REJOUER (m√™mes joueurs)</button>
            <button class="btn-main" style="background:var(--card); border:1px solid var(--border); color:var(--text);" onclick="app.showSetup()">üè† RETOUR MENU</button>
        </div>
    </div>

    <script>
        // Configuration Firebase - ScoreMaster
        const firebaseConfig = {
            apiKey: "AIzaSyD71m2ipLvr1hwpl8e66KM1Emz-grmd7mk",
            authDomain: "score-master-df904.firebaseapp.com",
            databaseURL: "https://score-master-df904-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "score-master-df904",
            storageBucket: "score-master-df904.firebasestorage.app",
            messagingSenderId: "1091987968374",
            appId: "1:1091987968374:web:1a491d7270eb5c7beb2a57",
            measurementId: "G-B049H3RZ9J"
        };

        // Variables globales
        let database = null;
        let useFirebase = false;
        
        // Initialiser Firebase imm√©diatement
        try {
            if(typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                useFirebase = true;
                console.log('üî• Firebase initialis√© avec succ√®s');
                console.log('‚úÖ Database:', firebaseConfig.databaseURL);
            } else {
                console.error('‚ùå Firebase SDK non charg√©');
            }
        } catch(e) {
            console.error('‚ùå Erreur initialisation Firebase:', e.message);
        }

// API de stockage - D√©finie IMM√âDIATEMENT en global
const StorageAPI = {

    async get(key, shared) {
        console.log('StorageAPI.get appel√©:', key, shared, 'useFirebase:', useFirebase);
        if(useFirebase && shared) {
            const snapshot = await database.ref(key).once('value');
            return { key, value: snapshot.val(), shared };
        } else {
            const storageKey = shared ? `shared_${key}` : `local_${key}`;
            const value = localStorage.getItem(storageKey);
            return { key, value, shared };
        }
    },

    async set(key, value, shared) {
        console.log('StorageAPI.set appel√©:', key, shared, 'useFirebase:', useFirebase);
        if(useFirebase && shared) {
            await database.ref(key).set(value);
            return { key, value, shared };
        } else {
            const storageKey = shared ? `shared_${key}` : `local_${key}`;
            localStorage.setItem(storageKey, value);
            return { key, value, shared };
        }
    },

    async delete(key, shared) {
        if(useFirebase && shared) {
            await database.ref(key).remove();
            return { key, deleted: true, shared };
        } else {
            const storageKey = shared ? `shared_${key}` : `local_${key}`;
            localStorage.removeItem(storageKey);
            return { key, deleted: true, shared };
        }
    }
};

window.storage = StorageAPI;

        
        console.log('‚úÖ StorageAPI d√©fini:', typeof StorageAPI, StorageAPI);

        const GameState = {
            create(mode, playerCount, isMultiplayer = false) {
                const colors = ['#007AFF','#FF2D55','#34C759','#FF9500','#AF52DE','#5AC8FA','#FFCC00','#5856D6'];
                return {
                    mode, isMultiplayer,
                    multiplayerCode: isMultiplayer ? this.generateCode() : null,
                    players: Array.from({length: Math.min(playerCount, 8)}, (_, i) => ({
                        id: i + 1, 
                        name: mode === 'belote' ? (i === 0 ? 'NOUS' : 'EUX') : `J${i + 1}`, 
                        color: colors[i], total: 0, previousRank: null
                    })),
                    history: [], temp: {}, dealerId: 1, celebratedMilestones: {},
                    lastUpdate: Date.now(), version: 1
                };
            },
            generateCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for(let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
                return code;
            },
            addRound(state, scores) {
                const round = {};
                state.players.forEach(p => { round[p.id] = scores[p.id] || 0; p.total += round[p.id]; });
                state.history.push(round);
                state.lastUpdate = Date.now();
                state.version++;
                return state;
            },
            updateRound(state, index, scores) {
                const oldRound = state.history[index];
                state.players.forEach(p => p.total -= (oldRound[p.id] || 0));
                const newRound = {};
                state.players.forEach(p => { newRound[p.id] = scores[p.id] || 0; p.total += newRound[p.id]; });
                state.history[index] = newRound;
                state.lastUpdate = Date.now();
                state.version++;
                return state;
            },
            deleteRound(state, index) {
                const round = state.history[index];
                state.players.forEach(p => p.total -= (round[p.id] || 0));
                state.history.splice(index, 1);
                state.lastUpdate = Date.now();
                state.version++;
                return state;
            },
            validate(scores, mode) {
                const values = Object.values(scores);
                if(values.some(v => v > 9999)) return { valid: false, error: 'Score trop √©lev√© (max 9999)' };
                if(mode === 'belote' && values.some(v => v < 0)) return { valid: false, error: 'Score n√©gatif impossible en Belote' };
                return { valid: true };
            }
        };

        const Multiplayer = {
            syncInterval: null, currentVersion: 0, isHost: false,
            async hostGame() {
                // Plus besoin de v√©rifier window.storage car on a le simulateur
                const mode = prompt('Mode de jeu ?\n1 = Belote\n2 = Standard', '1') === '1' ? 'belote' : 'standard';
                const playerCount = mode === 'belote' ? 2 : (parseInt(prompt("Nombre de joueurs ?", "4")) || 4);
                const state = GameState.create(mode, playerCount, true);
                const code = state.multiplayerCode;
                try {
                    await window.storage.set(`mp:${code}`, JSON.stringify(state), true);
                    this.isHost = true;
                    this.currentVersion = state.version;
                    this.showQRCode(code);
                    UI.showToast('‚úÖ Partie multijoueur cr√©√©e !', 'success');
                } catch(error) {
                    console.error('Error hosting game:', error);
                    UI.showToast('‚ùå Erreur lors de la cr√©ation', 'error');
                }
            },
            showQRCode(code) {
                document.getElementById('game-code-display').textContent = code;
                document.getElementById('qr-code').innerHTML = '';
                new QRCode(document.getElementById('qr-code'), {
                    text: code, width: 200, height: 200,
                    colorDark: '#000000', colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                document.getElementById('modal-qr').classList.add('active');
            },
            closeQRModal() { document.getElementById('modal-qr').classList.remove('active'); },
            async startMultiplayerGame() {
                const code = document.getElementById('game-code-display').textContent;
                try {
                    const result = await window.storage.get(`mp:${code}`, true);
                    if(!result) { UI.showToast('‚ùå Partie introuvable', 'error'); return; }
                    const gameData = JSON.parse(result.value);
                    app.currentGame = {
                        id: `mp_${code}_${Date.now()}`,
                        name: `${gameData.mode === 'belote' ? 'Belote' : 'Standard'} - Multijoueur`,
                        mode: gameData.mode, date: new Date().toISOString(),
                        state: gameData, finished: false,
                        isMultiplayer: true, multiplayerCode: code
                    };
                    this.closeQRModal();
                    this.startSync(code);
                    app.showGame();
                } catch(error) {
                    console.error('Error starting game:', error);
                    UI.showToast('‚ùå Erreur de connexion', 'error');
                }
            },
            showJoinModal() {
                // Plus besoin de v√©rifier car simulateur disponible
                document.getElementById('join-code-input').value = '';
                document.getElementById('modal-join').classList.add('active');
            },
            closeJoinModal() { document.getElementById('modal-join').classList.remove('active'); },
            async joinGame() {
                const code = document.getElementById('join-code-input').value.trim().toUpperCase();
                if(code.length !== 6) { UI.showToast('‚ö†Ô∏è Code invalide (6 caract√®res)', 'warning'); return; }
                try {
                    const result = await window.storage.get(`mp:${code}`, true);
                    if(!result) { UI.showToast('‚ùå Partie introuvable', 'error'); return; }
                    const gameData = JSON.parse(result.value);
                    app.currentGame = {
                        id: `mp_${code}_${Date.now()}`,
                        name: `${gameData.mode === 'belote' ? 'Belote' : 'Standard'} - Multijoueur`,
                        mode: gameData.mode, date: new Date().toISOString(),
                        state: gameData, finished: false,
                        isMultiplayer: true, multiplayerCode: code
                    };
                    this.isHost = false;
                    this.currentVersion = gameData.version;
                    this.closeJoinModal();
                    this.startSync(code);
                    app.showGame();
                    UI.showToast('‚úÖ Partie rejointe !', 'success');
                } catch(error) {
                    console.error('Error joining game:', error);
                    UI.showToast('‚ùå Erreur de connexion', 'error');
                }
            },
            async copyCode() {
                const code = document.getElementById('game-code-display').textContent;
                try {
                    await navigator.clipboard.writeText(code);
                    UI.showToast('üìã Code copi√© !', 'success');
                } catch(e) {
                    const input = document.createElement('input');
                    input.value = code;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    UI.showToast('üìã Code copi√© !', 'success');
                }
            },
            startSync(code) {
                this.stopSync();
                document.getElementById('sync-indicator').classList.remove('hidden');
                this.updateSyncStatus(true);
                this.syncInterval = setInterval(async () => {
                    try {
                        const result = await window.storage.get(`mp:${code}`, true);
                        if(!result) { this.updateSyncStatus(false); return; }
                        const serverState = JSON.parse(result.value);
                        if(serverState.version > this.currentVersion) {
                            app.currentGame.state = serverState;
                            this.currentVersion = serverState.version;
                            app.render();
                            if(navigator.vibrate) navigator.vibrate(20);
                        }
                        this.updateSyncStatus(true);
                    } catch(error) {
                        console.error('Sync error:', error);
                        this.updateSyncStatus(false);
                    }
                }, 1000);
            },
            stopSync() {
                if(this.syncInterval) { clearInterval(this.syncInterval); this.syncInterval = null; }
                document.getElementById('sync-indicator').classList.add('hidden');
            },
            async pushUpdate(state) {
                if(!app.currentGame?.isMultiplayer) return;
                const code = app.currentGame.multiplayerCode;
                try {
                    await window.storage.set(`mp:${code}`, JSON.stringify(state), true);
                    this.currentVersion = state.version;
                } catch(error) {
                    console.error('Push error:', error);
                    UI.showToast('‚ö†Ô∏è Erreur de synchronisation', 'warning');
                }
            },
            updateSyncStatus(connected) {
                const indicator = document.getElementById('sync-indicator');
                const icon = document.getElementById('sync-icon');
                const text = document.getElementById('sync-text');
                if(connected) {
                    indicator.classList.remove('disconnected');
                    icon.textContent = '‚ö°';
                    text.textContent = 'Synchronis√©';
                } else {
                    indicator.classList.add('disconnected');
                    icon.textContent = '‚ö†Ô∏è';
                    text.textContent = 'D√©connect√©';
                }
            }
        };

        const Storage = {
            GAMES_KEY: 'sm_v11_games', CURRENT_KEY: 'sm_v11_current',
            saveGame(game) {
                try {
                    const games = this.loadGames();
                    const existing = games.findIndex(g => g.id === game.id);
                    if(existing >= 0) games[existing] = game; else games.push(game);
                    localStorage.setItem(this.GAMES_KEY, JSON.stringify(games));
                    localStorage.setItem(this.CURRENT_KEY, game.id);
                    return true;
                } catch(e) {
                    if(e.name === 'QuotaExceededError') UI.showToast('‚ö†Ô∏è M√©moire pleine. Supprimez d\'anciennes parties.');
                    console.error('Save error:', e);
                    return false;
                }
            },
            loadGames() {
                try {
                    const data = localStorage.getItem(this.GAMES_KEY);
                    return data ? JSON.parse(data) : [];
                } catch(e) { console.error('Load error:', e); return []; }
            },
            loadCurrentGame() {
                const currentId = localStorage.getItem(this.CURRENT_KEY);
                if(!currentId) return null;
                return this.loadGames().find(g => g.id === currentId);
            },
            deleteGame(gameId) {
                const games = this.loadGames().filter(g => g.id !== gameId);
                localStorage.setItem(this.GAMES_KEY, JSON.stringify(games));
                const currentId = localStorage.getItem(this.CURRENT_KEY);
                if(currentId === gameId) localStorage.removeItem(this.CURRENT_KEY);
            },
            clearAll() {
                if(confirm('‚ö†Ô∏è Supprimer TOUTES les parties ?')) {
                    localStorage.removeItem(this.GAMES_KEY);
                    localStorage.removeItem(this.CURRENT_KEY);
                    UI.showToast('‚úÖ Historique effac√©', 'success');
                    app.renderGamesList();
                }
            }
        };

        const UI = {
            showToast(message, type = 'default') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast show';
                if(type !== 'default') toast.classList.add(type);
                setTimeout(() => toast.classList.remove('show'), 2500);
            },
            renderScoreCards(state) {
                const sorted = [...state.players].sort((a,b) => {
                    const aScore = a.total + (state.temp[a.id] || 0);
                    const bScore = b.total + (state.temp[b.id] || 0);
                    return bScore - aScore;
                });
                const grid = document.getElementById('grid');
                const rankChanges = new Set();
                state.players.forEach((p, idx) => {
                    const newRank = sorted.findIndex(s => s.id === p.id);
                    if(p.previousRank !== null && p.previousRank !== newRank) rankChanges.add(p.id);
                    p.previousRank = newRank;
                });
                grid.innerHTML = '';
                state.players.forEach(p => {
                    const tempScore = state.temp[p.id] || 0;
                    const totalScore = p.total + tempScore;
                    const rankIdx = sorted.findIndex(s => s.id === p.id);
                    let badgeClass = 'badge-none', badgeText = '#' + (rankIdx + 1);
                    if(rankIdx === 0) { badgeClass = 'badge-1'; badgeText = 'ü•á'; }
                    else if(rankIdx === 1) { badgeClass = 'badge-2'; badgeText = 'ü•à'; }
                    else if(rankIdx === 2) { badgeClass = 'badge-3'; badgeText = 'ü•â'; }
                    const card = document.createElement('div');
                    card.className = `p-card ${state.dealerId === p.id ? 'is-dealer' : ''}`;
                    if(rankChanges.has(p.id)) card.classList.add('rank-change');
                    card.innerHTML = `
                        <div class="rank-badge ${badgeClass} ${rankChanges.has(p.id) ? 'bounce' : ''}">${badgeText}</div>
                        <div class="p-name-btn" style="color:${p.color}; border-color:${p.color}40" onclick="app.openModal(${p.id})">${p.name}</div>
                        <div class="p-score ${tempScore !== 0 ? 'score-bump' : ''}" onclick="app.openSheet(${p.id})">${totalScore}</div>
                        <div class="p-temp">${tempScore ? (tempScore > 0 ? '+' + tempScore : tempScore) : ''}</div>
                        ${state.dealerId === p.id ? '<div style="position:absolute; top:8px; right:8px; font-size:12px;">üÉè</div>' : ''}
                    `;
                    grid.appendChild(card);
                });
            },
            renderHistory(state, editIdx) {
                const hist = document.getElementById('history');
                hist.innerHTML = '';
                state.history.slice().reverse().forEach((r, i) => {
                    const idx = state.history.length - 1 - i;
                    const isEditing = idx === editIdx;
                    const row = document.createElement('div');
                    row.className = 'h-row';
                    row.style.borderColor = isEditing ? 'var(--dealer)' : 'var(--border)';
                    let scoresHtml = '';
                    state.players.forEach(p => {
                        const score = isEditing && state.temp[p.id] !== undefined ? state.temp[p.id] : (r[p.id] || 0);
                        scoresHtml += `<div class="h-score-item"><div style="font-size:7px; color:${p.color}; font-weight:900; opacity:0.7">${p.name.substring(0,4)}</div><div style="color:${p.color}; font-weight:800; font-size:14px;">${score}</div></div>`;
                    });
                    row.innerHTML = `
                        <div class="h-idx">M${idx+1}</div>
                        <div class="h-scores" onclick="app.startEdit(${idx})">${scoresHtml}</div>
                        <button onclick="app.delRound(${idx})" style="border:none; background:none; color:var(--danger); font-size:18px; padding-left:10px; cursor:pointer;">√ó</button>
                    `;
                    hist.appendChild(row);
                });
            },
            renderChart(state, editIdx) {
                const ctx = document.getElementById('chart');
                if(!ctx) return;
                if(app.chart) app.chart.destroy();
                const datasets = state.players.map(p => {
                    let cumul = 0;
                    const data = [0];
                    state.history.forEach((h, idx) => {
                        if(idx === editIdx && state.temp[p.id] !== undefined) cumul += state.temp[p.id];
                        else cumul += (h[p.id] || 0);
                        data.push(cumul);
                    });
                    if(Object.keys(state.temp).length > 0 && editIdx === null) data.push(cumul + (state.temp[p.id] || 0));
                    return {
                        label: p.name, data, borderColor: p.color, backgroundColor: p.color + '20',
                        tension: 0.4, pointRadius: 3, pointHoverRadius: 6, borderWidth: 2.5, fill: false
                    };
                });
                const labels = ['0', ...state.history.map((_, i) => 'M' + (i + 1))];
                if(Object.keys(state.temp).length > 0 && editIdx === null) labels.push('...');
                app.chart = new Chart(ctx, {
                    type: 'line', data: { labels, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 12, titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 13 } }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 10, weight: '700' }, color: '#86868B' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(128,128,128,0.08)' }, ticks: { font: { size: 10, weight: '600' }, color: '#86868B' } }
                        },
                        animation: { duration: 400 }
                    }
                });
            },
            showVictory(winner, score, state) {
                const overlay = document.getElementById('victory');
                document.getElementById('victory-player').textContent = winner.name;
                document.getElementById('victory-player').style.color = winner.color;
                document.getElementById('victory-score').textContent = `${score} points`;
                const stats = this.calculateVictoryStats(winner, state);
                const statsHtml = `
                    <div class="victory-stat-row"><span class="victory-stat-label">Meilleur manche</span><span class="victory-stat-value" style="color:${winner.color}">${stats.bestRound} pts</span></div>
                    <div class="victory-stat-row"><span class="victory-stat-label">Pire manche</span><span class="victory-stat-value">${stats.worstRound} pts</span></div>
                    <div class="victory-stat-row"><span class="victory-stat-label">Moyenne par manche</span><span class="victory-stat-value">${stats.average} pts</span></div>
                    <div class="victory-stat-row"><span class="victory-stat-label">Manches gagn√©es</span><span class="victory-stat-value">${stats.roundsWon}/${state.history.length}</span></div>
                `;
                document.getElementById('victory-stats').innerHTML = statsHtml;
                overlay.classList.add('active');
                this.launchFireworks();
                if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
            },
            calculateVictoryStats(winner, state) {
                const winnerRounds = state.history.map(h => h[winner.id] || 0);
                const nonZeroRounds = winnerRounds.filter(r => r > 0);
                const bestRound = Math.max(...winnerRounds, 0);
                const worstRound = nonZeroRounds.length > 0 ? Math.min(...nonZeroRounds) : 0;
                const average = state.history.length > 0 ? Math.round(winner.total / state.history.length) : 0;
                let roundsWon = 0;
                state.history.forEach(round => {
                    const maxScore = Math.max(...state.players.map(p => round[p.id] || 0));
                    if(round[winner.id] === maxScore && maxScore > 0) roundsWon++;
                });
                return { bestRound, worstRound, average, roundsWon };
            },
            closeVictory() { document.getElementById('victory').classList.remove('active'); },
            launchFireworks() {
                const duration = 5000, end = Date.now() + duration;
                const colors = ['#007AFF', '#FF2D55', '#34C759', '#FF9500', '#AF52DE', '#FFD700'];
                (function frame() {
                    confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0, y: 0.8 }, colors: colors });
                    confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1, y: 0.8 }, colors: colors });
                    if (Date.now() < end) requestAnimationFrame(frame);
                })();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: colors });
            },
            launchMilestoneConfetti(score) {
                const colors = ['#007AFF', '#FF2D55', '#34C759', '#FF9500', '#AF52DE', '#FFD700'];
                confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: colors });
                confetti({ particleCount: 30, angle: 60, spread: 55, origin: { x: 0, y: 0.7 }, colors: colors });
                confetti({ particleCount: 30, angle: 120, spread: 55, origin: { x: 1, y: 0.7 }, colors: colors });
                let milestone = '';
                if(score >= 1000) milestone = 'üéâ 1000 POINTS !';
                else if(score >= 500) milestone = 'üéä 500 POINTS !';
                else if(score >= 200) milestone = '‚ú® 200 POINTS !';
                if(navigator.vibrate) {
                    if(score >= 1000) navigator.vibrate([50, 100, 50, 100, 50]);
                    else if(score >= 500) navigator.vibrate([50, 100, 50]);
                    else navigator.vibrate(100);
                }
                if(milestone) this.showToast(milestone);
            }
        };

        const app = {
            currentGame: null, activePlayerId: null, editIdx: null, chart: null, savedPlayers: {},
            init() {
                const savedTheme = localStorage.getItem('sm_theme');
                if(savedTheme) { document.documentElement.setAttribute('data-theme', savedTheme); this.updateThemeIcon(); }
                const savedPlayersData = localStorage.getItem('sm_saved_players');
                if(savedPlayersData) this.savedPlayers = JSON.parse(savedPlayersData);
                
                // Ne pas charger automatiquement une partie en cours pour √©viter les probl√®mes
                const game = Storage.loadCurrentGame();
                if(game && !game.isMultiplayer) { 
                    this.currentGame = game; 
                    this.showGame(); 
                } else {
                    this.showSetup();
                }
                this.renderGamesList();
            },
            toggleTheme() {
                const root = document.documentElement;
                const currentTheme = root.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                root.setAttribute('data-theme', newTheme);
                localStorage.setItem('sm_theme', newTheme);
                this.updateThemeIcon();
                if(navigator.vibrate) navigator.vibrate(30);
            },
            updateThemeIcon() {
                const theme = document.documentElement.getAttribute('data-theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = theme === 'dark' || (theme !== 'light' && prefersDark);
                document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            },
            showSetup() {
                document.getElementById('setup').classList.remove('hidden');
                document.getElementById('game').classList.add('hidden');
                document.getElementById('dock').classList.add('hidden');
                document.getElementById('victory').classList.remove('active');
                Multiplayer.stopSync();
                this.currentGame = null; this.editIdx = null;
                this.renderGamesList();
            },
            showModeSelection(mode) {
                const playerCount = mode === 'belote' ? 2 : (parseInt(prompt("Nombre de joueurs ?", "4")) || 4);
                if(this.currentGame && this.currentGame.mode === mode) {
                    this.savedPlayers[mode] = this.currentGame.state.players.map(p => ({ name: p.name, color: p.color }));
                    localStorage.setItem('sm_saved_players', JSON.stringify(this.savedPlayers));
                }
                this.createGame(mode, playerCount);
            },
            createGame(mode, playerCount) {
                this.currentGame = {
                    id: Date.now().toString(),
                    name: mode === 'belote' ? 'Belote' : 'Partie Standard',
                    mode, date: new Date().toISOString(),
                    state: GameState.create(mode, playerCount), finished: false
                };
                if(this.savedPlayers[mode]) {
                    const saved = this.savedPlayers[mode];
                    this.currentGame.state.players.forEach((p, idx) => {
                        if(saved[idx]) { p.name = saved[idx].name; p.color = saved[idx].color; }
                    });
                }
                Storage.saveGame(this.currentGame);
                this.showGame();
            },
            loadGame(gameId) {
                const games = Storage.loadGames();
                this.currentGame = games.find(g => g.id === gameId);
                if(this.currentGame) { Storage.saveGame(this.currentGame); this.showGame(); }
            },
            showGame() {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('game').classList.remove('hidden');
                document.getElementById('dock').classList.remove('hidden');
                document.getElementById('mode-title').textContent = this.currentGame.mode === 'belote' ? 'BELOTE' : 'STANDARD';
                const mpInfo = document.getElementById('multiplayer-info');
                if(this.currentGame.isMultiplayer) {
                    mpInfo.classList.remove('hidden');
                    mpInfo.innerHTML = `<span class="multiplayer-badge">üåê MULTIJOUEUR ‚Ä¢ ${this.currentGame.multiplayerCode}</span>`;
                } else mpInfo.classList.add('hidden');
                const isBelote = this.currentGame.mode === 'belote';
                document.getElementById('calc-btn').classList.toggle('hidden', !isBelote);
                document.getElementById('btn-82').classList.toggle('hidden', !isBelote);
                document.getElementById('btn-50').classList.toggle('hidden', isBelote);
                document.getElementById('smart-btn').textContent = isBelote ? 'CAPOT' : '+/-';
                this.render();
            },
            render() {
                if(!this.currentGame) return;
                const state = this.currentGame.state;
                UI.renderScoreCards(state);
                UI.renderHistory(state, this.editIdx);
                UI.renderChart(state, this.editIdx);
                Storage.saveGame(this.currentGame);
            },
            renderGamesList() {
                const games = Storage.loadGames();
                const list = document.getElementById('games-list');
                if(games.length === 0) { list.innerHTML = '<p style="text-align:center; color:var(--text-sec); padding:20px;">Aucune partie enregistr√©e</p>'; return; }
                list.innerHTML = '';
                games.slice().reverse().forEach(game => {
                    const sortedPlayers = [...game.state.players].sort((a,b) => b.total - a.total);
                    const date = new Date(game.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                    const modeBadge = game.mode === 'belote' ? '<span class="game-mode-badge badge-belote">üÉè BELOTE</span>' : '<span class="game-mode-badge badge-standard">üé≤ STANDARD</span>';
                    const item = document.createElement('div');
                    item.className = 'game-item';
                    let playersScoresHtml = '';
                    sortedPlayers.forEach((p, idx) => {
                        const isWinner = idx === 0;
                        playersScoresHtml += `<div class="game-player-score" style="background:${p.color}20; color:${p.color}; border: 1px solid ${p.color}40;">${isWinner ? 'üèÜ ' : ''}${p.name}: ${p.total}</div>`;
                    });
                    item.innerHTML = `
                        <div onclick="app.loadGame('${game.id}')" style="flex:1; cursor:pointer;">
                            <div style="font-weight:900; font-size:16px; margin-bottom:6px;">${game.name} ${game.finished ? '‚úì' : ''} ${modeBadge}</div>
                            <div style="font-size:12px; color:var(--text-sec); margin-bottom:8px;">${date} ‚Ä¢ ${game.state.history.length} manches</div>
                            <div class="game-players-list">${playersScoresHtml}</div>
                        </div>
                        <div class="game-actions"><button onclick="event.stopPropagation(); app.deleteGame('${game.id}')" title="Supprimer">üóëÔ∏è</button></div>
                    `;
                    list.appendChild(item);
                });
            },
            deleteGame(gameId) {
                if(confirm('Supprimer cette partie ?')) { Storage.deleteGame(gameId); UI.showToast('‚úÖ Partie supprim√©e', 'success'); this.renderGamesList(); }
            },
            restartWithSamePlayers() {
                if(!this.currentGame) return;
                UI.closeVictory();
                if(!this.currentGame.finished) { this.currentGame.finished = true; Storage.saveGame(this.currentGame); }
                const oldState = this.currentGame.state;
                const newGame = {
                    id: Date.now().toString(),
                    name: this.currentGame.mode === 'belote' ? 'Belote' : 'Partie Standard',
                    mode: this.currentGame.mode, date: new Date().toISOString(),
                    state: {
                        mode: oldState.mode,
                        players: oldState.players.map(p => ({ ...p, total: 0, previousRank: null })),
                        history: [], temp: {}, dealerId: oldState.dealerId, celebratedMilestones: {}
                    },
                    finished: false
                };
                this.currentGame = newGame;
                Storage.saveGame(newGame);
                UI.showToast('üéÆ Nouvelle partie lanc√©e !', 'success');
                this.render();
            },
            finishGame() {
                if(this.currentGame.state.history.length === 0) { UI.showToast('‚ö†Ô∏è Aucune manche jou√©e', 'warning'); return; }
                this.currentGame.finished = true;
                Storage.saveGame(this.currentGame);
                this.savedPlayers[this.currentGame.mode] = this.currentGame.state.players.map(p => ({ name: p.name, color: p.color }));
                localStorage.setItem('sm_saved_players', JSON.stringify(this.savedPlayers));
                const winner = [...this.currentGame.state.players].sort((a,b) => b.total - a.total)[0];
                UI.showVictory(winner, winner.total, this.currentGame.state);
            },
            openModal(playerId) {
                this.editPlayerId = playerId;
                const player = this.currentGame.state.players.find(p => p.id === playerId);
                document.getElementById('modal-title').textContent = player.name;
                document.getElementById('modal-title').style.color = player.color;
                document.getElementById('edit-name').value = player.name;
                document.getElementById('edit-dealer').checked = (this.currentGame.state.dealerId === playerId);
                document.getElementById('modal-player').classList.add('active');
            },
            closeModal() { document.getElementById('modal-player').classList.remove('active'); },
            savePlayer() {
                const player = this.currentGame.state.players.find(p => p.id === this.editPlayerId);
                const newName = document.getElementById('edit-name').value.trim().toUpperCase();
                if(newName) player.name = newName;
                if(document.getElementById('edit-dealer').checked) this.currentGame.state.dealerId = player.id;
                this.closeModal();
                this.render();
            },
            openSheet(playerId) {
                this.activePlayerId = playerId;
                const isBelote = this.currentGame.mode === 'belote';
                document.getElementById('calc-btn').classList.toggle('hidden', !isBelote);
                document.getElementById('btn-82').classList.toggle('hidden', !isBelote);
                document.getElementById('btn-50').classList.toggle('hidden', isBelote);
                this.renderSwitcher();
                document.getElementById('sheet').classList.add('active');
            },
            closeSheet() { document.getElementById('sheet').classList.remove('active'); this.render(); },
            renderSwitcher() {
                const cont = document.getElementById('input-switcher');
                cont.innerHTML = '';
                this.currentGame.state.players.forEach(p => {
                    const isActive = p.id === this.activePlayerId;
                    const tempScore = this.currentGame.state.temp[p.id] || 0;
                    const div = document.createElement('div');
                    div.className = `sel-box ${isActive ? 'active' : ''}`;
                    if(isActive) div.style.setProperty('--p-color', p.color);
                    div.onclick = () => { this.activePlayerId = p.id; this.renderSwitcher(); };
                    div.innerHTML = `<div style="font-size:10px; font-weight:800; color:${isActive ? p.color : 'var(--text-sec)'}">${p.name}</div><div style="font-size:20px; font-weight:900">${tempScore}</div>`;
                    cont.appendChild(div);
                });
            },
            typeNum(n) {
                const current = (this.currentGame.state.temp[this.activePlayerId] || 0).toString();
                const newVal = parseInt((current === '0' ? '' : current) + n);
                if(newVal > 9999) { if(navigator.vibrate) navigator.vibrate([50, 50, 50]); UI.showToast('‚ö†Ô∏è Maximum 9999 points', 'warning'); return; }
                if(navigator.vibrate) navigator.vibrate(10);
                this.currentGame.state.temp[this.activePlayerId] = newVal;
                this.renderSwitcher();
                this.render();
            },
            addVal(value) {
                const current = this.currentGame.state.temp[this.activePlayerId] || 0;
                const newVal = current + value;
                if(newVal > 9999) { if(navigator.vibrate) navigator.vibrate([50, 50, 50]); UI.showToast('‚ö†Ô∏è Maximum 9999 points', 'warning'); return; }
                if(navigator.vibrate) navigator.vibrate(20);
                this.currentGame.state.temp[this.activePlayerId] = Math.max(0, newVal);
                this.renderSwitcher();
                this.render();
            },
            backspace() {
                const current = (this.currentGame.state.temp[this.activePlayerId] || 0).toString();
                this.currentGame.state.temp[this.activePlayerId] = current.length > 1 ? parseInt(current.slice(0, -1)) : 0;
                if(navigator.vibrate) navigator.vibrate(15);
                this.renderSwitcher();
                this.render();
            },
            clearInput() {
                this.currentGame.state.temp[this.activePlayerId] = 0;
                if(navigator.vibrate) navigator.vibrate([30, 50, 30]);
                this.renderSwitcher();
                this.render();
            },
            handleSmart() {
                if(this.currentGame.mode === 'belote') {
                    this.currentGame.state.temp[this.activePlayerId] = 252;
                } else {
                    const current = this.currentGame.state.temp[this.activePlayerId] || 0;
                    this.currentGame.state.temp[this.activePlayerId] = current * -1;
                }
                this.renderSwitcher();
                this.render();
            },
            calcRest() {
                const otherPlayer = this.currentGame.state.players.find(p => p.id !== this.activePlayerId);
                if(otherPlayer) {
                    const currentScore = this.currentGame.state.temp[this.activePlayerId] || 0;
                    this.currentGame.state.temp[otherPlayer.id] = Math.max(0, 162 - currentScore);
                    this.activePlayerId = otherPlayer.id;
                    this.renderSwitcher();
                    this.render();
                }
            },
            async validateRound() {
                const state = this.currentGame.state;
                if(Object.keys(state.temp).length === 0) { UI.showToast('‚ö†Ô∏è Aucun score saisi', 'warning'); return; }
                const validation = GameState.validate(state.temp, this.currentGame.mode);
                if(!validation.valid) { UI.showToast(validation.error, 'error'); return; }
                const previousTotals = {};
                state.players.forEach(p => { previousTotals[p.id] = p.total; });
                if(this.editIdx !== null) {
                    GameState.updateRound(state, this.editIdx, state.temp);
                    this.editIdx = null;
                    document.getElementById('save-btn').textContent = 'ENREGISTRER LA MANCHE';
                    document.getElementById('save-btn').classList.remove('editing');
                    UI.showToast('‚úÖ Manche modifi√©e', 'success');
                } else {
                    GameState.addRound(state, state.temp);
                    const currentIdx = state.players.findIndex(p => p.id === state.dealerId);
                    state.dealerId = state.players[(currentIdx + 1) % state.players.length].id;
                    UI.showToast('‚úÖ Manche enregistr√©e', 'success');
                }
                if(this.currentGame.isMultiplayer) await Multiplayer.pushUpdate(state);
                if(this.currentGame.mode === 'standard') {
                    state.players.forEach(p => {
                        const milestones = [200, 500, 1000];
                        milestones.forEach(milestone => {
                            const key = `${p.id}-${milestone}`;
                            if(!state.celebratedMilestones[key] && previousTotals[p.id] < milestone && p.total >= milestone) {
                                state.celebratedMilestones[key] = true;
                                setTimeout(() => UI.launchMilestoneConfetti(milestone), 300);
                            }
                        });
                    });
                }
                if(this.currentGame.mode === 'belote') {
                    const winner = state.players.find(p => p.total >= 1000);
                    if(winner) {
                        this.savedPlayers[this.currentGame.mode] = state.players.map(p => ({ name: p.name, color: p.color }));
                        localStorage.setItem('sm_saved_players', JSON.stringify(this.savedPlayers));
                        this.currentGame.finished = true;
                        Storage.saveGame(this.currentGame);
                        Multiplayer.stopSync();
                        setTimeout(() => { UI.showVictory(winner, winner.total, state); }, 500);
                    }
                }
                state.temp = {};
                this.render();
            },
            startEdit(idx) {
                const state = this.currentGame.state;
                if(Object.keys(state.temp).length > 0) { if(!confirm('Abandonner la saisie en cours ?')) return; }
                this.editIdx = idx;
                state.temp = {...state.history[idx]};
                document.getElementById('save-btn').textContent = `MODIFIER MANCHE ${idx + 1}`;
                document.getElementById('save-btn').classList.add('editing');
                this.openSheet(state.players[0].id);
            },
            delRound(idx) {
                if(!confirm('Supprimer cette manche ?')) return;
                GameState.deleteRound(this.currentGame.state, idx);
                UI.showToast('‚úÖ Manche supprim√©e', 'success');
                this.render();
            },
            undo() {
                const history = this.currentGame.state.history;
                if(history.length > 0) this.delRound(history.length - 1);
            }
        };

        app.init();
        
        // Test des fonctions de base au chargement
        setTimeout(() => {
            console.log('‚úÖ ScoreMaster v11.0 - Firebase Edition');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üìä Modules charg√©s:');
            console.log('  - GameState:', typeof GameState !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - Storage (local):', typeof Storage !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - UI:', typeof UI !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - Multiplayer:', typeof Multiplayer !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - Chart.js:', typeof Chart !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - Confetti:', typeof confetti !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - QRCode:', typeof QRCode !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  - Firebase SDK:', typeof firebase !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            const statusBadge = document.getElementById('firebase-status');
            
            if(useFirebase) {
                console.log('üî• MODE: FIREBASE ACTIF');
                console.log('‚úÖ Synchronisation multi-appareils activ√©e');
                console.log('üí° Scanne le QR code depuis un autre t√©l√©phone!');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                // Test de connexion Firebase
                console.log('üß™ Test de connexion Firebase...');
                database.ref('.info/connected').on('value', (snap) => {
                    if (snap.val() === true) {
                        console.log('‚úÖ Connect√© √† Firebase Realtime Database');
                    } else {
                        console.log('‚ö†Ô∏è D√©connect√© de Firebase');
                    }
                });
                
                // Test d'√©criture pour v√©rifier les permissions
                database.ref('test_connection').set({
                    timestamp: Date.now(),
                    message: 'Test de connexion'
                }).then(() => {
                    console.log('‚úÖ Test d\'√©criture r√©ussi - Permissions OK');
                    database.ref('test_connection').remove();
                }).catch((error) => {
                    console.error('‚ùå Test d\'√©criture √©chou√©:', error.message);
                    console.error('‚ö†Ô∏è PROBL√àME DE PERMISSIONS D√âTECT√â !');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üìù Pour corriger:');
                    console.log('1. Va sur console.firebase.google.com');
                    console.log('2. S√©lectionne ton projet "score-master-df904"');
                    console.log('3. Menu Realtime Database > R√®gles');
                    console.log('4. Colle ce code:');
                    console.log('{');
                    console.log('  "rules": {');
                    console.log('    "mp": {');
                    console.log('      "$gameCode": {');
                    console.log('        ".read": true,');
                    console.log('        ".write": true');
                    console.log('      }');
                    console.log('    }');
                    console.log('  }');
                    console.log('}');
                    console.log('5. Clique PUBLIER');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                });
                
                if(statusBadge) {
                    statusBadge.textContent = 'üî• ACTIF';
                    statusBadge.style.background = 'var(--success)';
                }
            } else {
                console.log('‚ö†Ô∏è MODE: LOCAL UNIQUEMENT');
                console.log('üì± Sync limit√©e au m√™me appareil');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('Pour activer Firebase:');
                console.log('1. V√©rifie que les scripts Firebase sont charg√©s');
                console.log('2. V√©rifie la console pour les erreurs');
                console.log('3. Configure les r√®gles de s√©curit√© Firebase');
                if(statusBadge) {
                    statusBadge.textContent = '‚ö†Ô∏è LOCAL';
                    statusBadge.style.background = 'var(--dealer)';
                }
            }
        }, 200);
    </script>
</body>
</html>